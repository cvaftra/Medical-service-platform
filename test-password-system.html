<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密码系统测试</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 10px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>密码系统测试页面</h1>
    
    <div class="test-section">
        <h2>1. 测试数据库连接</h2>
        <button onclick="testDatabaseConnection()">测试数据库连接</button>
        <div id="db-test-result" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 测试用户注册</h2>
        <input type="email" id="test-email" placeholder="测试邮箱" value="test@example.com">
        <input type="password" id="test-password" placeholder="测试密码" value="test12345">
        <button onclick="testRegistration()">测试注册</button>
        <div id="reg-test-result" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 测试用户登录</h2>
        <button onclick="testLogin()">测试登录</button>
        <div id="login-test-result" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 查看用户列表</h2>
        <button onclick="listUsers()">查看用户列表</button>
        <div id="users-list" class="log"></div>
    </div>

    <script src="supabase.js"></script>
    <script>
        let logCount = 0;
        
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span class="${type}">${message}</span>`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            logCount++;
        }
        
        async function testDatabaseConnection() {
            log('db-test-result', '开始测试数据库连接...');
            try {
                const result = await AuthService.testDatabaseConnection();
                if (result.success) {
                    log('db-test-result', '✅ 数据库连接成功', 'success');
                } else {
                    log('db-test-result', '❌ 数据库连接失败: ' + result.error, 'error');
                }
            } catch (error) {
                log('db-test-result', '❌ 测试异常: ' + error.message, 'error');
            }
        }
        
        async function testRegistration() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            if (!email || !password) {
                log('reg-test-result', '请输入邮箱和密码', 'error');
                return;
            }
            
            log('reg-test-result', `开始测试用户注册: ${email}`);
            
            try {
                const userData = {
                    fullname: '测试用户',
                    phone: '1234567890'
                };
                
                const result = await AuthService.register(email, password, userData);
                
                if (result.success) {
                    log('reg-test-result', `✅ 注册成功 - 用户ID: ${result.user.id}`, 'success');
                    log('reg-test-result', `✅ 密码已明文保存到数据库`, 'success');
                    localStorage.setItem('test_user', JSON.stringify(result.user));
                } else {
                    log('reg-test-result', `❌ 注册失败: ${result.error}`, 'error');
                }
            } catch (error) {
                log('reg-test-result', `❌ 注册异常: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            if (!email || !password) {
                log('login-test-result', '请输入邮箱和密码', 'error');
                return;
            }
            
            log('login-test-result', `开始测试用户登录: ${email}`);
            
            try {
                const result = await AuthService.login(email, password);
                
                if (result.success) {
                    log('login-test-result', `✅ 登录成功 - 欢迎 ${result.user.full_name || result.user.email}`, 'success');
                    log('login-test-result', `✅ 密码验证通过，从数据库直接读取并比较`, 'success');
                } else {
                    log('login-test-result', `❌ 登录失败: ${result.error}`, 'error');
                }
            } catch (error) {
                log('login-test-result', `❌ 登录异常: ${error.message}`, 'error');
            }
        }
        
        async function listUsers() {
            log('users-list', '开始获取用户列表...');
            
            try {
                const result = await DataService.getUsers();
                
                if (result.success) {
                    log('users-list', `✅ 获取到 ${result.data.length} 个用户`, 'success');
                    
                    result.data.forEach(user => {
                        const userInfo = `ID: ${user.id}\n邮箱: ${user.email}\n密码: ${user.password}\n姓名: ${user.full_name}\n电话: ${user.phone}\n状态: ${user.status}`;
                        log('users-list', userInfo);
                    });
                } else {
                    log('users-list', `❌ 获取用户列表失败: ${result.error}`, 'error');
                }
            } catch (error) {
                log('users-list', `❌ 获取用户列表异常: ${error.message}`, 'error');
            }
        }
        
        // 页面加载后自动测试数据库连接
        window.addEventListener('load', () => {
            log('db-test-result', '页面加载完成，准备测试...');
            setTimeout(() => {
                testDatabaseConnection();
            }, 1000);
        });
    </script>
</body>
</html>